'use strict';const DOM={appWrapper:$('#app-wrapper'),confirmModal:$('#confirm-modal'),loginModal:$('#login-modal'),eventModal:$('#event-modal'),eventRegistrationModal:$('#event-registration-modal')},Errors={login_required:'\u30ED\u30B0\u30A4\u30F3\u3057\u3066\u304F\u3060\u3055\u3044',duplicated:'\u3059\u3067\u306B\u767B\u9332\u6E08\u3067\u3059',forbidden:'\u6A29\u9650\u304C\u3042\u308A\u307E\u305B\u3093',authentication_failed:'\u8A8D\u8A3C\u306B\u5931\u6557\u3057\u307E\u3057\u305F',not_found:'\u5B58\u5728\u3057\u307E\u305B\u3093',invalid_rank:'\u305D\u306E\u30E9\u30F3\u30AF\u3092\u6307\u5B9A\u3059\u308B\u3053\u3068\u306F\u3067\u304D\u307E\u305B\u3093',invalid_event:'\u305D\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u6307\u5B9A\u3059\u308B\u3053\u3068\u306F\u3067\u304D\u307E\u305B\u3093',invalid_sheet:'\u305D\u306E\u30B7\u30FC\u30C8\u3092\u6307\u5B9A\u3059\u308B\u3053\u3068\u306F\u3067\u304D\u307E\u305B\u3093',not_reserved:'\u305D\u306E\u5E2D\u306F\u4E88\u7D04\u3055\u308C\u3066\u3044\u307E\u305B\u3093',not_permitted:'\u305D\u306E\u64CD\u4F5C\u306F\u3067\u304D\u307E\u305B\u3093',unwknown:'\u4E0D\u660E\u306A\u30A8\u30E9\u30FC\u3067\u3059'};function showError(a){const b=Errors[a];setTimeout(()=>{alert(b||a)},300)}function showWaitingDialog(a){return new Promise(b=>{waitingDialog.show(a||'Loading...'),setTimeout(()=>{b()},300)})}function hideWaitingDialog(){waitingDialog.hide()}const API=(()=>{const a=c=>{return c.json()},b=c=>{return'error'in c?Promise.reject(c.error):Promise.resolve(c)};return{Administrator:{login(c,f){return fetch('/admin/api/actions/login',{method:'POST',headers:new Headers({'Content-Type':'application/json'}),body:JSON.stringify({login_name:c,password:f}),credentials:'same-origin'}).then(a).then(b)},logout(){return fetch('/admin/api/actions/logout',{method:'POST',headers:new Headers({'Content-Type':'application/json'}),body:'{}',credentials:'same-origin'})}},Event:{register(c,f,g){return fetch('/admin/api/events',{method:'POST',headers:new Headers({'Content-Type':'application/json'}),body:JSON.stringify({title:c,price:f,public:g}),credentials:'same-origin'}).then(a).then(b)},edit(c,f,g){return fetch(`/admin/api/events/${c}/actions/edit`,{method:'POST',headers:new Headers({'Content-Type':'application/json'}),body:JSON.stringify({public:f,closed:g}),credentials:'same-origin'}).then(a).then(b)},getAll(){return fetch('/admin/api/events',{method:'GET',credentials:'same-origin'}).then(a).then(b)},getDetails(c){return fetch('/admin/api/events/'+c,{method:'GET',credentials:'same-origin'}).then(a).then(b)}},Report:{getEventSales(c){window.open(`/admin/api/reports/events/${c}/sales`)},getTotalSales(){window.open('/admin/api/reports/sales')}}}})(),ConfirmModal=new Vue({el:'#confirm-modal .modal-dialog',data:{title:'',message:'',callback:null},methods:{ok(){null===this.callback||(this.callback(),this.callback=null,DOM.confirmModal.modal('hide'))}}});function confirm(a,b){return new Promise(c=>{ConfirmModal.$data.title=a,ConfirmModal.$data.message=b,ConfirmModal.$data.callback=c,DOM.confirmModal.modal('show')})}const EventList=new Vue({el:'.events',data(){const a=DOM.appWrapper.data('administrator'),b=DOM.appWrapper.data('events');return{events:b,ranks:['S','A','B','C'],isAdmin:null!==a}},methods:{open(a){openEventModal(a)},openEventRegistrationModal(){DOM.eventRegistrationModal.modal('show')}}}),EventModal=new Vue({el:'#event-modal .modal-dialog',data(){return{event:{sheets:{S:{},A:{},B:{},C:{}}},ranks:['S','A','B','C']}},methods:{divRange(a,b){const c=Math.floor(a/b),f=[];for(let g=1;g<=c;g++)f.push(g);return f},isSoldOut(a){return 0===this.event.sheets[a].remains},publish(){confirm('\u30A4\u30D9\u30F3\u30C8\u306E\u516C\u958B','\u3053\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u516C\u958B\u3057\u307E\u3059\u304B\uFF1F').then(()=>{return API.Event.edit(this.event.id,!0,!1)}).then(b=>{this.event=b}).catch(b=>{showError(b)})},close(){confirm('\u30A4\u30D9\u30F3\u30C8\u306E\u7D42\u4E86','\u3053\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u7D42\u4E86\u3057\u307E\u3059\u304B\uFF1F (\u623B\u3059\u3053\u3068\u306F\u3067\u304D\u307E\u305B\u3093)').then(()=>{return API.Event.edit(this.event.id,!1,!0)}).then(b=>{this.event=b}).catch(b=>{showError(b)})},disappear(){confirm('\u30A4\u30D9\u30F3\u30C8\u306E\u516C\u958B\u505C\u6B62','\u3053\u306E\u30A4\u30D9\u30F3\u30C8\u306E\u516C\u958B\u3092\u505C\u6B62\u3057\u307E\u3059\u304B\uFF1F').then(()=>{return API.Event.edit(this.event.id,!1,!1)}).then(b=>{this.event=b}).catch(b=>{showError(b)})},downloadSalesReport(){API.Report.getEventSales(this.event.id)}}});function updateEventModal(a){return new Promise((b,c)=>{API.Event.getDetails(a).then(f=>{EventModal.$data.event=f,b(f)}).catch(f=>{showError(f),c(f)})})}function openEventModal(a){updateEventModal(a).then(()=>DOM.eventModal.modal('show'))}const MenuBar=new Vue({el:'#menu-bar',data(){const a=DOM.appWrapper.data('administrator');return{currentAdministrator:a}},methods:{signIn(){DOM.loginModal.modal('show')},signOut(){confirm('\u30B5\u30A4\u30F3\u30A2\u30A6\u30C8','\u672C\u5F53\u306B\u30B5\u30A4\u30F3\u30A2\u30A6\u30C8\u3057\u307E\u3059\u304B\uFF1F').then(()=>{return API.Administrator.logout()}).then(()=>{this.currentAdministrator=null,EventList.$data.isAdmin=!1,EventList.$data.events=[]})},downloadSalesReport(){API.Report.getTotalSales()}}});new Vue({el:'#login-modal .modal-dialog',data(){return{loginName:'',password:''}},methods:{submit(){API.Administrator.login(this.loginName,this.password).then(a=>{return MenuBar.$data.currentAdministrator=a,DOM.loginModal.modal('hide'),showWaitingDialog()}).then(()=>{return API.Event.getAll()}).then(a=>{hideWaitingDialog(),EventList.$data.isAdmin=!0,EventList.$data.events=a}).catch(a=>{hideWaitingDialog(),showError(a)})}}}),new Vue({el:'#event-registration-modal .modal-dialog',data(){return{title:'',price:1e3,public:0}},methods:{submit(){API.Event.register(this.title,this.price,0!=this.public).then(a=>{EventList.$data.events.push(a),DOM.eventRegistrationModal.modal('hide')}).catch(a=>{showError(a)})}}}),$('body').on('shown.bs.modal','.modal',a=>{$('input',a.target).first().focus()});